<!DOCTYPE html>
<html lang="fr"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://lkdjiin.github.io/atom.xml" title="Xavier Nayrac" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Xavier Nayrac</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">À propos</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">La stack du processeur 6502</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2026-01-31T08:00:00+01:00" itemprop="datePublished">31 January 2026
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>La <em>stack</em> (sans anglicisme : la pile) est un endroit particulier de la mémoire.
Le processeur s’en sert tout seul comme un grand pour y ranger l’adresse de
retour lorsque vous appelez une sous routine. <em>Sous routine</em> c’est le nom qu’on
donne aux fonctions quand on fait de l’assembleur, mais à part dans la
littérature, je ne connais personne qui parle comme ça ;)
On peut aussi utilisez cette <em>stack</em> explicitement, pour y déposer ou retirer
des octets.</p>

<!-- more -->

<p>On appelle ça une pile parce que ça fonctionne comme une pile d’assiette.
Pour faire une pile vous déposez les assiettes les unes au dessus des autres.
Et pour les retirer, vous commençez par celle qui est au-dessus de la pile.
Pour être précis il s’agit d’une pile <em>last in, first out</em>, en français :
dernier entré, premier sorti.</p>

<p>Le processeur 6502 possède une <em>stack</em> de 256 octets.
Elle se situe entre les adresses $100 et $1ff.
Le registre de <em>stack</em>, nommé <strong>SP</strong> (<em>stack pointer</em>), fait 8 bits. Ce qui explique pourquoi la pile ne fait que 256 octets.
Matériellement, le 6502 ajoute un <strong>‘1’</strong> devant la valeur contenue dans SP pour atteindre une adresse entre
$100 et $1ff. Par exemple, si SP contient $ab le 6502 utilisera en réalité
l’adresse $1ab.
La <em>stack</em> fonctionne “à l’envers”, le 1er emplacement est à $1ff, le second
est à $1fe, et ainsi de suite jusqu’à $100, qui est le dernier emplacement.</p>

<p>Une <em>stack</em> de seulement 256 octets peut paraître bien maigre de prime abord.
Mais d’après des sources qui semblent bien informées, c’est largement suffisant.
Et je dois dire que je n’ai jamais eu de problème de ce côté là.</p>

<h2 id="état-initial-au-lancement-dun-programme">État initial au lancement d’un programme</h2>

<p>Lançons un programme sur Commodore 64 pour voir dans quel état est notre <em>stack</em>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BasicUpstart2(start)
start:
  nop
  .break
  nop
</code></pre></div></div>

<p>Dans le débuggeur de VICE j’affiche le contenu des registres. SP contient la valeur $f6.
Ce qui signifie que la prochaine valeur sera déposée en $1f6 (ou retirée de $1f6).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(C:$080f) r
  ADDR A  X  Y  SP 00 01 NV-BDIZC LIN CYC  STOPWATCH
.;080f 00 00 00 f6 2f 37 00100000 271 001    3063754
                ^^
</code></pre></div></div>

<p>L’affichage de la zone mémoire de la <em>stack</em> donne ce qui suit :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(C:$080f) m 100 1ff
&gt;C:0100  33 38 39 31  31 00 30 30  30 30 ff ff  ff ff 00 00
&gt;C:0110  00 00 ff ff  ff ff 00 00  00 00 ff ff  ff ff 00 00
&gt;C:0120  00 00 ff ff  ff ff 00 00  00 00 ff ff  ff ff 00 00
&gt;C:0130  00 00 ff ff  ff ff 00 00  00 00 ff ff  ff ff 00 00
&gt;C:0140  00 00 ff ff  ff ff 00 00  00 00 ff ff  ff ff 00 00
&gt;C:0150  00 00 ff ff  ff ff 00 00  00 00 ff ff  ff ff 10 00
&gt;C:0160  00 00 ff ff  ff ff 00 00  00 00 ff ff  ff ff 00 00
&gt;C:0170  00 00 ff ff  ff ff 00 00  00 00 ff ff  ff ff 00 00
&gt;C:0180  00 00 ff ff  ff ff 00 00  00 00 ff ff  ff ff 00 00
&gt;C:0190  00 00 ff ff  ff ff 00 00  00 00 ff ff  ff ff 00 00
&gt;C:01a0  00 00 ff ff  ff ff 00 00  00 00 ff ff  ff ff 00 00
&gt;C:01b0  00 00 ff ff  ff ff 00 00  00 00 ff ff  ff ff 00 00
&gt;C:01c0  00 00 ff ff  fe ff 00 00  00 00 ff ff  ff ff 00 00
&gt;C:01d0  00 00 ff ff  ff ff 00 00  00 00 ff ff  ff ff 00 00
&gt;C:01e0  00 00 ff 7d  ea 7d ea 00  61 00 22 0e  bc 81 64 b8
&gt;C:01f0  0c bd ba b7  bc 03 00 46  e1 e9 a7 a7  79 a6 9c e3
</code></pre></div></div>

<p>Que la <em>stack</em> ne soit pas vide ne devrait pas nous surprendre. Il s’est passé
un tas de chose avant le lancement de notre programme.</p>

<h2 id="push-pull">Push Pull</h2>

<p>En assembleur, on <em>push</em> (pousse) des données sur la pile, ou on <em>pull</em> (tire)
des données de la pile. Le processeur 6502 a une instruction <code class="language-plaintext highlighter-rouge">pha</code> qui envoie
sur la pile le contenu du registre A. Il a aussi une instruction <code class="language-plaintext highlighter-rouge">pla</code> qui
retire une donnée de la pile pour la placer dans le registre A.</p>

<p>Étudions le petit programme suivant qui va placer la valeur 5 sur la pile, puis
la retirer.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BasicUpstart2(start)
start:
  .break
  lda #5
  pha
  pla
  rts
</code></pre></div></div>

<p>Comme précedemment, le haut de la pile est initialement placé à l’adresse $1f6 :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(C:$080e) r
  ADDR A  X  Y  SP 00 01 NV-BDIZC LIN CYC  STOPWATCH
.;080e 00 00 00 f6 2f 37 00100000 068 019    3070639
                ^^
</code></pre></div></div>

<p>Cette adresse mémoire contient pour l’instant la valeur 0 :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(C:$080e) m 1f0 1ff
&gt;C:01f0  0c bd ba b7  bc 03 00 46  e1 e9 a7 a7  79 a6 9c e3
                            ^^
</code></pre></div></div>

<p>L’instruction <code class="language-plaintext highlighter-rouge">pha</code> va donc placer la valeur 5 à l’adresse $1f6 et décrementer
le registre SP.
Après l’execution de l’instruction <code class="language-plaintext highlighter-rouge">pha</code> le haut de la pile est maintenant à
l’adresse $1f5 et l’emplacement mémoire $1f6 contient bien la valeur 5 :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(C:$0811) r
  ADDR A  X  Y  SP 00 01 NV-BDIZC LIN CYC  STOPWATCH
.;0811 05 00 00 f5 2f 37 00100000 068 024    3070644
                ^^

(C:$0811) m 1f0 1ff
&gt;C:01f0  0c bd ba b7  bc 03 05 46  e1 e9 a7 a7  79 a6 9c e3
                            ^^ L'instruction `pla` fait l'inverse. Elle incrémente le registre SP et copie la valeur du haut de la pile dans le registre A. Notez que le contenu de $1f6 n'a pas été modifié. C'est toujours 5. Le processeur n'a aucun moyen de savoir ce qu'il contenait avant le `pha`.

(C:$0812) r
  ADDR A  X  Y  SP 00 01 NV-BDIZC LIN CYC  STOPWATCH
.;0812 05 00 00 f6 2f 37 00100000 068 028    3070648
       ^^       ^^

(C:$0812) m 1f0 1ff
&gt;C:01f0  0c bd ba b7  bc 03 05 46  e1 e9 a7 a7  79 a6 9c e3
                            ^^ ## Saut vers une routine et retour
</code></pre></div></div>

<p>Sur le 6502 on appelle une routine avec l’instruction <code class="language-plaintext highlighter-rouge">jsr</code> (<em>Jump to SubRoutine</em>).
À la fin de la routine on revient au programme principal à l’aide de l’instruction
<code class="language-plaintext highlighter-rouge">rts</code> (<em>ReTurn from Subroutine</em>). Ces deux instructions utilisent la pile.
Voyons comment avec le programme suivant :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BasicUpstart2(start)

start:
  .break
  jsr my_routine
  nop
  rts

my_routine:
  nop
  nop
  rts
</code></pre></div></div>

<p>Dans le débuggeur je le désassemble pour connaître les adresses des instructions.
On voit que la routine <code class="language-plaintext highlighter-rouge">my_routine</code> débute à l’adresse $0813 :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(C:$080e) d
.C:080e   .start:
.C:080e  20 13 08    JSR .my_routine
.C:0811  EA          NOP
.C:0812  60          RTS
.C:0813   .my_routine:
.C:0813  EA          NOP
.C:0814  EA          NOP
.C:0815  60          RTS
</code></pre></div></div>

<p>Affichons les registres et le contenu de la pile avant l’instruction <code class="language-plaintext highlighter-rouge">jsr</code>.
C’est toujours la même chose, la pile pointe en $1f6 :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(C:$080e) r
  ADDR A  X  Y  SP 00 01 NV-BDIZC LIN CYC  STOPWATCH
.;080e 00 00 00 f6 2f 37 00100000 008 003    3165123
(C:$080e) m 1f0 1ff
&gt;C:01f0  0c bd ba b7  bc 03 00 46  e1 e9 a7 a7  79 a6 9c e3
</code></pre></div></div>

<p>Lançons la routine. On voit qu’après le passage de l’instruction <code class="language-plaintext highlighter-rouge">jsr</code> la pile
a été décrementée deux fois et pointe maintenant en $1f4. Les emplacements
$1f5 et $1f6 contiennent le nombre $0810 (inversé, au format <em>big endian</em>) qui
est l’adresse de retour de la routine. Ou plus précisement, qui est l’adresse
que contenait le PC (<em>Program Counter</em>) à la fin du traitement de l’instruction <code class="language-plaintext highlighter-rouge">jsr</code>
par le processeur. (Dans le listing désassemblé on voit bien que c’est à l’adresse
$0811 que devra revenir la routine.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(C:$0200) z
.C:0813  EA          NOP            - A:00 X:00 Y:00 SP:f4
(C:$0813) r
  ADDR A  X  Y  SP 00 01 NV-BDIZC LIN CYC  STOPWATCH
.;0813 00 00 00 f4 2f 37 00100000 008 009    3165129
                ^^
(C:$0813) m 1f0 1ff
&gt;C:01f0  0c bd ba b7  bc 10 08 46  e1 e9 a7 a7  79 a6 9c e3
                         ^^^^^
</code></pre></div></div>

<p>Confirmons maintenant ce raisonnement en regardant ce qu’il se passe avec
l’instruction <code class="language-plaintext highlighter-rouge">rts</code>. Elle saute à l’adresse contenue en haut de pile (plus 1).
Ici on atterrit donc à l’adresse $0811. De plus elle décremente <strong>SP</strong> deux fois :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.C:0815  60          RTS            - A:00 X:00 Y:00 SP:f4
(C:$0815) n
.C:0811  EA          NOP            - A:00 X:00 Y:00 SP:f6
(C:$0811) m 1f0 1ff
&gt;C:01f0  0c bd ba b7  bc 10 08 46  e1 e9 a7 a7  79 a6 9c e3
</code></pre></div></div>

<p>Voilà comment fonctionne la <em>stack</em> du processeur 6502.</p>

  </div>

  <br/>
  <br/>
  <div style="text-align: center">/ / / / / / / / / /</div>
  <br/>
  <br/>

  <div style="text-align: center">
    
      <a href="/blog/2026/01/28/la-logique-de-l-horloge/" title="Article précédent: La logique de l'horloge">&laquo; La logique de l'horloge</a> ---//---
    
    
      <a href="/blog/2026/02/02/premieres-connexions/" title="Article suivant: Premières connexions sur le 65C02">Premières connexions sur le 65C02 &raquo;</a>
    
  </div>

  <br/>
  <br/><h2>Commentaires</h2>

<p>
<em>Pas encore trouvé de solution simple et non-invasive pour avoir des
commentaires sur le blog. En attendant vous pouvez laisser votre commentaire
et/ou engager une discussion sur </em>
<a href="https://ruby.social/@lkdjiin">mastodon@lkdjiin</a>
ou
<a href="https://x.com/lkdjiin">twitter@lkdjiin</a>
</p>
<a class="u-url" href="/blog/2026/01/31/la-stack-du-6502/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div>
    <p class="rss-subscribe">s'abonner <a href="/atom.xml">via RSS</a></p>
    </div>

    <h2 class="footer-heading">Xavier Nayrac</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            Copyright 2013 - 2026
            </li><li><a class="u-email" href="mailto:"></a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list">

  <li style="margin-bottom:10px;">
    <a href="https://github.com/lkdjiin">
      <img src="/images/github.png" />
      <span class="username">lkdjiin</span>
    </a>
  </li>

  <li style="margin-bottom:10px;">
    <a href="https://ruby.social/@lkdjiin">
      <img src="/images/mastodon.png" />
      <span class="username">lkdjiin</span>
    </a>
  </li>

  <li style="margin-bottom:10px;">
    <a href="https://x.com/lkdjiin">
      <img src="/images/twitter.png" />
      <span class="username">lkdjiin</span>
    </a>
  </li>

  <li style="margin-bottom:10px;">
    <a href="/atom.xml">
      <img src="/images/atom.png" />
      <span class="username">RSS</span>
    </a>
  </li>
</ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Dev accro au TDD, brasseur d&#39;appartement, musicien, maker, ex créateur d&#39;effets pour guitare, heureux utilisateur de Vim.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
